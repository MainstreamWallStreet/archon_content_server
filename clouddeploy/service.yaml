# clouddeploy/service.yaml
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: zergling-api
spec:
  template:
    metadata:
      annotations:
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€ runtime resources â”€â”€â”€â”€â”€â”€â”€â”€â”€
        run.googleapis.com/memory: "4Gi"              # RAM per instance
        run.googleapis.com/cpu:    "2"                # vCPUs per instance
        run.googleapis.com/container-concurrency: "2" # requests handled in parallel
        # keep full CPU even while idle (optional, costs more)
        run.googleapis.com/cpu-throttling: "false"
    spec:
      volumes:
        # â”€â”€â”€â”€â”€ Secret-backed volume for Google SA â”€â”€â”€â”€â”€
        - name: google-sa
          secret:
            secretName: zergling-google-sa-value
            items:
              - key: latest
                path: google-sa.json
      containers:
        - name: zergling
          image: zergling                   # ðŸ”„ Cloud Deploy patches this tag
          resources:
            limits:
              memory: 4Gi                  # duplicate limits are fine
              cpu: "2"
          ports:
            - containerPort: 8080
          env:
            # â”€â”€â”€â”€â”€ Static environment variables â”€â”€â”€â”€â”€
            - name: EXAMPLE_BUCKET
              value: "zergling-data"
            - name: DEBUG
              value: "false"
            - name: LOG_LEVEL
              value: "INFO"
            # â”€â”€â”€â”€â”€ Google Service Account â”€â”€â”€â”€â”€
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: "/secrets/google-sa.json"
          envFrom:
            - secretRef:
                name: zergling-api-key
                key: latest
          volumeMounts:
            - name: google-sa
              mountPath: /secrets
              readOnly: true
