# clouddeploy/service.yaml
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: banshee-api
spec:
  template:
    metadata:
      annotations:
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€ runtime resources â”€â”€â”€â”€â”€â”€â”€â”€â”€
        run.googleapis.com/memory: "4Gi"              # RAM per instance
        run.googleapis.com/cpu:    "2"                # vCPUs per instance
        run.googleapis.com/container-concurrency: "2" # requests handled in parallel
        # keep full CPU even while idle (optional, costs more)
        run.googleapis.com/cpu-throttling: "false"
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€ service account â”€â”€â”€â”€â”€â”€â”€â”€â”€
        run.googleapis.com/service-account: "cloud-run-banshee-sa@${PROJECT_ID}.iam.gserviceaccount.com"
    spec:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ environment variables â”€â”€â”€â”€â”€â”€â”€â”€â”€
      containerConcurrency: 2
      timeoutSeconds: 300
      containers:
        - name: api
          image: api                   # ðŸ”„ Cloud Deploy patches this tag
          resources:
            limits:
              memory: 4Gi                  # duplicate limits are fine
              cpu: "2"
          env:
            # â”€â”€â”€â”€â”€ Static environment variables â”€â”€â”€â”€â”€
            - name: GOOGLE_CLOUD_PROJECT
              value: "${PROJECT_ID}"
            - name: JOB_QUEUE_BUCKET
              value: "banshee-data"
            - name: BANSHEE_DATA_BUCKET
              value: "banshee-data"
            - name: ENV
              value: "production"
            
            # â”€â”€â”€â”€â”€ API Keys from Secret Manager â”€â”€â”€â”€â”€
            - name: API_NINJAS_KEY
              valueFrom:
                secretKeyRef:
                  name: api-ninjas-key
                  key: latest
            - name: RAVEN_API_KEY
              valueFrom:
                secretKeyRef:
                  name: raven-api-key
                  key: latest
            - name: BANSHEE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: banshee-api-key
                  key: latest
            - name: SENDGRID_API_KEY
              valueFrom:
                secretKeyRef:
                  name: sendgrid-api-key
                  key: latest
            
            # â”€â”€â”€â”€â”€ Google Service Account â”€â”€â”€â”€â”€
            - name: GOOGLE_SA_VALUE
              valueFrom:
                secretKeyRef:
                  name: banshee-google-sa-value
                  key: latest
            
            # â”€â”€â”€â”€â”€ Alert Configuration â”€â”€â”€â”€â”€
            - name: ALERT_FROM_EMAIL
              valueFrom:
                secretKeyRef:
                  name: alert-from-email
                  key: latest
            - name: ALERT_RECIPIENTS
              valueFrom:
                secretKeyRef:
                  name: alert-recipients
                  key: latest
            
            # â”€â”€â”€â”€â”€ Web Interface â”€â”€â”€â”€â”€
            - name: BANSHEE_WEB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: banshee-web-password
                  key: latest
