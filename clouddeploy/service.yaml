# clouddeploy/service.yaml
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: zergling-api
spec:
  template:
    metadata:
      annotations:
        # ───────── runtime resources ─────────
        run.googleapis.com/memory: "4Gi"              # RAM per instance
        run.googleapis.com/cpu:    "2"                # vCPUs per instance
        run.googleapis.com/container-concurrency: "2" # requests handled in parallel
        # keep full CPU even while idle (optional, costs more)
        run.googleapis.com/cpu-throttling: "false"
        # ───────── service account ─────────
        run.googleapis.com/service-account: "cloud-run-zergling-sa@${PROJECT_ID}.iam.gserviceaccount.com"
    spec:
      # ───────── environment variables ─────────
      containerConcurrency: 2
      timeoutSeconds: 300
      containers:
        - image: ${_REGION}-docker.pkg.dev/${PROJECT_ID}/zergling/zergling:${TAG}
          ports:
            - containerPort: 8080
          env:
            # ───── API Configuration ─────
            - name: ZERGLING_API_KEY
              valueFrom:
                secretKeyRef:
                  name: zergling-api-key
                  key: latest
            
            # ───── Google Cloud Storage ─────
            - name: ZERGLING_DATA_BUCKET
              value: "zergling-data-${PROJECT_ID}"
            - name: EARNINGS_BUCKET
              value: "zergling-earnings-${PROJECT_ID}"
            - name: EMAIL_QUEUE_BUCKET
              value: "zergling-email-queue-${PROJECT_ID}"
            
            # ───── Google Service Account ─────
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: "/secrets/google-sa.json"
          volumeMounts:
            - name: google-sa
              mountPath: /secrets
              readOnly: true
      volumes:
        - name: google-sa
          secret:
            secretName: zergling-google-sa-value
